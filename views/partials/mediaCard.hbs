{{! views/partials/mediaCard.hbs }}
{{#each items}}
<div class="{{../cardClass}}" data-item-json="{{json this}}"> {{!-- Store item data --}}
    <img src="{{defaultIfEmpty imageUrl '/images/placeholder.png'}}" alt="{{title}}" class="card-image" onerror="this.onerror=null; this.src='/images/placeholder.png';">
    <div class="card-content">
        <h3 class="card-title">{{title}}</h3>
        <p class="card-meta">
            <span class="tag tag-{{classify (defaultIfEmpty mediaType type)}}">{{defaultIfEmpty mediaType type}}</span>
            {{#if releaseDate}}<span>Released: {{formatYear releaseDate}}</span>{{/if}}
            {{#if publishedDate}}<span>Published: {{formatYear publishedDate}}</span>{{/if}} {{!-- For books --}}
             {{#if authors}}<span>Author(s): {{join authors ", "}}</span>{{/if}}

            {{!-- API Rating (from search or stored) --}}
            {{#if rating}}<span>API Rating: {{rating}}/20</span>{{/if}}

            {{#unless ../isSearchResult}} {{!-- Library item specific meta --}}
                 <span class="tag tag-status-{{classify userStatus}}">Status: <strong>{{userStatus}}</strong></span>
                 {{#if userRating}}<span>My Rating: {{userRating}}/20</span>{{/if}}
                 {{#if addedAt}}<span>Added: {{formatDate addedAt}}</span>{{/if}}
                 {{#if watchedAt}}<span>Completed: {{formatDate watchedAt}}</span>{{/if}}
            {{/unless}}
        </p>
        <p class="card-description truncated">
            {{#if ../isSearchResult}}
                {{! Use description from search, fallback to apiDescription if structure differs }}
                {{defaultIfEmpty description apiDescription}}
            {{else}}
                <strong>My Notes:</strong> {{defaultIfEmpty userDescription "None"}}
            {{/if}}
        </p>
        {{#unless ../isSearchResult}}
             {{#if apiDescription}}
             <details class="api-desc-details"><summary>Original Description</summary><p>{{apiDescription}}</p></details>
             {{/if}}
        {{/unless}}

        <div class="card-actions">
            {{#if ../isSearchResult}}
                 {{!-- Add button triggers modal via event delegation --}}
                <button class="btn btn-primary btn-small action-add">Add to Library</button>
            {{else}}
                 {{!-- Edit/Delete buttons trigger actions via event delegation --}}
                <button class="btn btn-secondary btn-small action-edit">Edit</button>
                <button class="btn btn-danger btn-small action-delete">Delete</button>
            {{/if}}
             {{!-- Details button triggers modal via event delegation (even on library items) --}}
             <button class="btn btn-secondary btn-small action-details">Details</button>
        </div>
    </div>
</div>
{{else}}
    {{#unless ../hidePlaceholder}} {{!-- Allow hiding placeholder during loading --}}
    <p class="placeholder-text">{{defaultIfEmpty ../placeholder "No items found."}}</p>
    {{/unless}}
{{/each}}